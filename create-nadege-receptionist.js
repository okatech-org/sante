#!/usr/bin/env node

import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';

// Charger les variables d'environnement depuis .env.local
dotenv.config({ path: './.env.local' });

// Configuration Supabase
const SUPABASE_URL = process.env.VITE_SUPABASE_URL || process.env.SUPABASE_URL;
const SUPABASE_ANON_KEY = process.env.VITE_SUPABASE_PUBLISHABLE_KEY;
const SUPABASE_SERVICE_ROLE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!SUPABASE_URL || !SUPABASE_ANON_KEY || !SUPABASE_SERVICE_ROLE_KEY) {
  console.error('‚ùå Variables d\'environnement manquantes dans .env.local');
  console.error('   Assurez-vous que VITE_SUPABASE_URL, VITE_SUPABASE_PUBLISHABLE_KEY et SUPABASE_SERVICE_ROLE_KEY sont d√©finis');
  process.exit(1);
}

// Client avec anon key pour signUp
const supabaseAnon = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

// Client admin avec service role key
const supabaseAdmin = createClient(SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
});

// Compte de Nad√®ge Oyono - R√©ceptionniste SOGARA
const nadegeAccount = {
  email: "accueil.sogara@sante.ga",
  password: "Reception@SOGARA2025",
  full_name: "Nad√®ge Oyono",
  role: "receptionist",
  department: "Accueil",
  matricule: "REC-002",
  professional_type: "receptionist",
  etablissement: "Centre M√©dical de Sant√© au Travail SOGARA",
  phone: "+241 01 55 26 21",
  poste: "R√©ceptionniste",
  permissions: [
    'manage_appointments',
    'patient_registration',
    'view_analytics',
    'reception',
    'appointments'
  ]
};

async function getOrCreateEstablishment() {
  try {
    // V√©rifier si l'√©tablissement SOGARA existe
    const { data: establishments, error } = await supabaseAdmin
      .from('establishments')
      .select('id, raison_sociale')
      .or('raison_sociale.ilike.%SOGARA%,raison_sociale.ilike.%Centre M√©dical de Sant√© au Travail%')
      .limit(1);

    if (!establishments || establishments.length === 0) {
      console.log('üìç Cr√©ation de l\'√©tablissement SOGARA...');
      
      const { data: newEst, error: createError } = await supabaseAdmin
        .from('establishments')
        .insert({
          raison_sociale: 'Centre M√©dical de Sant√© au Travail SOGARA',
          type_etablissement: 'centre_medical',
          secteur: 'prive',
          ville: 'Port-Gentil',
          province: 'Ogoou√©-Maritime',
          adresse: 'Route de la Sogara',
          telephone: '011 55 26 21',
          email: 'cmst@sogara.com',
          latitude: -0.681398,
          longitude: 8.772557,
          nombre_lits_total: 200,
          nombre_blocs_operatoires: 4,
          nombre_salles_consultation: 15,
          service_urgences_actif: true,
          cnamgs_conventionne: true,
          cnss_conventionne: true,
          statut: 'actif',
          description: 'Centre M√©dical de Sant√© au Travail au service des employ√©s de SOGARA et leurs ayants droit'
        })
        .select()
        .single();

      if (createError) {
        console.error('‚ùå Erreur cr√©ation √©tablissement:', createError);
        return null;
      }
      
      console.log('‚úÖ √âtablissement SOGARA cr√©√© avec succ√®s');
      return newEst.id;
    }
    
    console.log(`‚úÖ √âtablissement trouv√©: ${establishments[0].raison_sociale}`);
    return establishments[0].id;
  } catch (error) {
    console.error('‚ùå Erreur:', error);
    return null;
  }
}

async function createNadegeAccount(establishmentId) {
  try {
    console.log('\nüè• CR√âATION DU COMPTE DE NAD√àGE OYONO - R√âCEPTIONNISTE CMST SOGARA');
    console.log('‚ïê'.repeat(70));
    console.log(`\nüìù Cr√©ation du compte: ${nadegeAccount.full_name}`);
    console.log(`   üìß Email: ${nadegeAccount.email}`);
    console.log(`   üë§ Poste: ${nadegeAccount.poste}`);
    console.log(`   üè¢ Service: ${nadegeAccount.department}`);

    // 1. Cr√©er ou mettre √† jour l'utilisateur dans Auth
    const { data: { user }, error: authError } = await supabaseAnon.auth.signUp({
      email: nadegeAccount.email,
      password: nadegeAccount.password,
      email_confirm: true,
      user_metadata: {
        full_name: nadegeAccount.full_name,
        department: nadegeAccount.department,
        matricule: nadegeAccount.matricule,
        establishment: nadegeAccount.etablissement,
        poste: nadegeAccount.poste
      }
    });

    let userId;
    
    if (authError && authError.message.includes('already exists')) {
      console.log('   ‚îú‚îÄ Utilisateur existant, mise √† jour...');
      
      // R√©cup√©rer l'utilisateur existant
      const { data: { users } } = await supabaseAdmin.auth.admin.listUsers();
      const existingUser = users?.find(u => u.email === nadegeAccount.email);
      
      if (existingUser) {
        userId = existingUser.id;
        
        // Mettre √† jour le mot de passe et les m√©tadonn√©es
        await supabaseAdmin.auth.admin.updateUserById(userId, {
          password: nadegeAccount.password,
          email_confirm: true,
          user_metadata: {
            full_name: nadegeAccount.full_name,
            department: nadegeAccount.department,
            matricule: nadegeAccount.matricule,
            establishment: nadegeAccount.etablissement,
            poste: nadegeAccount.poste
          }
        });
        console.log('   ‚îú‚îÄ ‚úÖ Compte mis √† jour avec succ√®s');
      }
    } else if (authError) {
      throw authError;
    } else {
      userId = user.id;
      console.log('   ‚îú‚îÄ ‚úÖ Compte cr√©√© avec succ√®s');
    }

    // 2. Cr√©er/Mettre √† jour le profil utilisateur
    const { error: profileError } = await supabaseAdmin
      .from('profiles')
      .upsert({
        id: userId,
        full_name: nadegeAccount.full_name,
        email: nadegeAccount.email,
        phone: nadegeAccount.phone,
        role: nadegeAccount.role,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }, {
        onConflict: 'id'
      });

    if (profileError) {
      console.log('   ‚îú‚îÄ ‚ö†Ô∏è  Erreur profil:', profileError.message);
    } else {
      console.log('   ‚îú‚îÄ ‚úÖ Profil cr√©√©/mis √† jour');
    }

    // 3. Assigner le r√¥le r√©ceptionniste
    const { error: roleError } = await supabaseAdmin
      .from('user_roles')
      .upsert({
        user_id: userId,
        role: nadegeAccount.role
      }, {
        onConflict: 'user_id,role'
      });

    if (roleError && !roleError.message.includes('duplicate')) {
      console.log('   ‚îú‚îÄ ‚ö†Ô∏è  Erreur r√¥le:', roleError.message);
    } else {
      console.log('   ‚îú‚îÄ ‚úÖ R√¥le assign√©: R√©ceptionniste');
    }

    // 4. Cr√©er le profil professionnel
    const { error: profError } = await supabaseAdmin
      .from('professionals')
      .upsert({
        user_id: userId,
        professional_type: nadegeAccount.professional_type,
        numero_ordre: nadegeAccount.matricule,
        specialite: 'Accueil et Gestion Administrative',
        etablissement: nadegeAccount.etablissement,
        ville: 'Port-Gentil',
        adresse: 'Route de la Sogara',
        telephone: nadegeAccount.phone,
        is_verified: true,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }, {
        onConflict: 'user_id'
      });

    if (profError && !profError.message.includes('duplicate')) {
      console.log('   ‚îú‚îÄ ‚ö†Ô∏è  Erreur profil professionnel:', profError.message);
    } else {
      console.log('   ‚îú‚îÄ ‚úÖ Profil professionnel cr√©√©');
    }

    // 5. Lier √† l'√©tablissement SOGARA
    if (establishmentId) {
      // Cr√©er le lien dans establishment_users
      const { error: linkError } = await supabaseAdmin
        .from('establishment_users')
        .upsert({
          establishment_id: establishmentId,
          user_id: userId,
          role: 'receptionniste',
          permissions: {
            manage_appointments: true,
            patient_registration: true,
            view_analytics: true,
            manage_reception: true,
            view_patients: true,
            manage_waiting_list: true,
            generate_reports: false,
            manage_staff: false,
            manage_billing: false
          },
          actif: true,
          created_at: new Date().toISOString()
        }, {
          onConflict: 'establishment_id,user_id'
        });

      if (linkError && !linkError.message.includes('duplicate')) {
        console.log('   ‚îú‚îÄ ‚ö†Ô∏è  Erreur liaison √©tablissement:', linkError.message);
      } else {
        console.log('   ‚îú‚îÄ ‚úÖ Li√©e √† l\'√©tablissement SOGARA');
      }

      // Cr√©er l'entr√©e dans establishment_staff
      const { error: staffError } = await supabaseAdmin
        .from('establishment_staff')
        .upsert({
          establishment_id: establishmentId,
          professional_id: userId,
          role_title: 'R√©ceptionniste',
          role_category: 'administrative',
          department: 'Accueil',
          service: 'R√©ception',
          is_department_head: false,
          is_service_head: false,
          is_establishment_admin: false,
          can_manage_staff: false,
          can_manage_schedules: false,
          can_view_finances: false,
          can_approve_orders: false,
          permissions: nadegeAccount.permissions,
          schedule_type: 'fixed',
          weekly_hours: 40,
          schedule_details: {
            monday: { start: '08:00', end: '17:00', break: '12:00-13:00' },
            tuesday: { start: '08:00', end: '17:00', break: '12:00-13:00' },
            wednesday: { start: '08:00', end: '17:00', break: '12:00-13:00' },
            thursday: { start: '08:00', end: '17:00', break: '12:00-13:00' },
            friday: { start: '08:00', end: '17:00', break: '12:00-13:00' },
            saturday: { start: '08:00', end: '12:00' },
            sunday: null
          },
          accepts_appointments: false,
          appointment_types: [],
          contract_type: 'cdi',
          contract_start_date: '2024-01-01',
          status: 'active',
          created_at: new Date().toISOString(),
          updated_at: new Date().toISOString()
        }, {
          onConflict: 'establishment_id,professional_id'
        });

      if (staffError && !staffError.message.includes('duplicate')) {
        console.log('   ‚îú‚îÄ ‚ö†Ô∏è  Erreur staff √©tablissement:', staffError.message);
      } else {
        console.log('   ‚îú‚îÄ ‚úÖ Ajout√©e au staff de l\'√©tablissement');
      }
    }

    console.log('   ‚îî‚îÄ ‚úÖ Compte configur√© avec succ√®s!\n');
    return true;

  } catch (error) {
    console.error(`   ‚îî‚îÄ ‚ùå Erreur:`, error.message);
    return false;
  }
}

async function main() {
  try {
    // R√©cup√©rer ou cr√©er l'√©tablissement SOGARA
    const establishmentId = await getOrCreateEstablishment();
    
    if (!establishmentId) {
      console.error('‚ùå Impossible de cr√©er/trouver l\'√©tablissement SOGARA');
      process.exit(1);
    }
    
    console.log(`\nüìç √âtablissement SOGARA ID: ${establishmentId}`);
    
    // Cr√©er le compte de Nad√®ge
    const success = await createNadegeAccount(establishmentId);
    
    if (success) {
      console.log('‚ïê'.repeat(70));
      console.log('\nüéâ COMPTE CR√â√â AVEC SUCC√àS!\n');
      console.log('üìã INFORMATIONS DE CONNEXION:');
      console.log('‚îÄ'.repeat(70));
      console.log(`\nüë§ Nom complet      : ${nadegeAccount.full_name}`);
      console.log(`üìß Email            : ${nadegeAccount.email}`);
      console.log(`üîë Mot de passe     : ${nadegeAccount.password}`);
      console.log(`üíº Poste            : ${nadegeAccount.poste}`);
      console.log(`üè¢ Service          : ${nadegeAccount.department}`);
      console.log(`üè• √âtablissement    : ${nadegeAccount.etablissement}`);
      console.log(`üì± T√©l√©phone        : ${nadegeAccount.phone}`);
      console.log(`üÜî Matricule        : ${nadegeAccount.matricule}`);
      console.log(`üîí R√¥le syst√®me     : ${nadegeAccount.role}`);
      
      console.log('\nüìç ACC√àS ET PERMISSIONS:');
      console.log('‚îÄ'.repeat(70));
      console.log('‚úÖ Gestion des rendez-vous');
      console.log('‚úÖ Enregistrement des patients');
      console.log('‚úÖ Consultation des statistiques');
      console.log('‚úÖ Gestion de la r√©ception');
      console.log('‚úÖ Gestion de la liste d\'attente');
      console.log('‚úÖ Visualisation des patients');
      console.log('‚ùå Gestion du personnel');
      console.log('‚ùå Gestion de la facturation');
      console.log('‚ùå G√©n√©ration de rapports financiers');
      
      console.log('\nüí° UTILISATION:');
      console.log('‚îÄ'.repeat(70));
      console.log('1. Aller sur: https://sante.ga/login/professional');
      console.log('2. Se connecter avec l\'email et le mot de passe ci-dessus');
      console.log('3. Acc√®s au tableau de bord de r√©ception');
      console.log('4. Gestion des rendez-vous et de l\'accueil des patients');
      
      console.log('\nüîê FONCTIONNALIT√âS PRINCIPALES:');
      console.log('‚îÄ'.repeat(70));
      console.log('‚Ä¢ Enregistrement et accueil des patients');
      console.log('‚Ä¢ Gestion de la file d\'attente');
      console.log('‚Ä¢ Planification et modification des rendez-vous');
      console.log('‚Ä¢ V√©rification de l\'assurance (CNAMGS/CNSS)');
      console.log('‚Ä¢ Orientation des patients vers les services');
      console.log('‚Ä¢ Gestion des urgences et priorit√©s');
      console.log('‚Ä¢ Communication avec les services m√©dicaux');
      console.log('‚Ä¢ Statistiques d\'affluence et rapports d\'activit√©');
      
      console.log('\n‚öôÔ∏è INT√âGRATION SYST√àME:');
      console.log('‚îÄ'.repeat(70));
      console.log('‚Ä¢ Interface d√©di√©e pour la r√©ception');
      console.log('‚Ä¢ Synchronisation avec l\'agenda des m√©decins');
      console.log('‚Ä¢ Notifications automatiques pour les rendez-vous');
      console.log('‚Ä¢ Acc√®s en lecture aux dossiers patients');
      console.log('‚Ä¢ Syst√®me de tickets et num√©rotation');
      console.log('‚Ä¢ Tableau de bord temps r√©el de l\'activit√©');
    } else {
      console.log('\n‚ùå √âchec de la cr√©ation du compte');
    }
    
  } catch (error) {
    console.error('\n‚ùå ERREUR CRITIQUE:', error);
    process.exit(1);
  }
}

// Ex√©cuter le script
main()
  .then(() => {
    console.log('\n‚úÖ Script termin√© avec succ√®s');
    process.exit(0);
  })
  .catch(error => {
    console.error('‚ùå Erreur fatale:', error);
    process.exit(1);
  });
