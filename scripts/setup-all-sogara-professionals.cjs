/**
 * Script pour configurer TOUS les professionnels SOGARA avec le syst√®me multi-√©tablissements
 * Date: 30/10/2025
 * 
 * Ce script configure tous les comptes professionnels SOGARA pour qu'ils soient
 * pr√™ts √† recevoir des r√¥les multiples et √† utiliser le nouveau syst√®me
 */

const { createClient } = require('@supabase/supabase-js');
require('dotenv').config();

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('‚ùå Variables d\'environnement manquantes');
  process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseServiceKey);

const CMST_SOGARA_ID = 'a1b2c3d4-e5f6-7890-abcd-ef1234567890';

// Configuration de TOUS les professionnels SOGARA
const SOGARA_PROFESSIONALS = {
  // Direction
  'directeur.sogara@sante.ga': {
    name: 'Dr. Jules DJEKI',
    roles: [
      { role: 'director', department: 'DIR', position: 'Directeur M√©dical', isAdmin: true },
      { role: 'doctor', department: 'MED', position: 'M√©decin Consultant Senior', isAdmin: false }
    ]
  },
  'admin.sogara@sante.ga': {
    name: 'Jean-Pierre Mbadinga',
    roles: [
      { role: 'admin', department: 'ADM', position: 'Administrateur Principal', isAdmin: true }
    ]
  },
  
  // M√©decins
  'dr.okemba.sogara@sante.ga': {
    name: 'Dr. Marie Okemba',
    roles: [
      { role: 'doctor', department: 'MED', position: 'M√©decin G√©n√©raliste', isAdmin: false }
    ]
  },
  'dr.nguema.sogara@sante.ga': {
    name: 'Dr. Paul Nguema',
    roles: [
      { role: 'doctor', department: 'URG', position: 'M√©decin Urgentiste', isAdmin: false, isDeptHead: true }
    ]
  },
  'dr.mbina.sogara@sante.ga': {
    name: 'Dr. L√©a Mbina',
    roles: [
      { role: 'doctor', department: 'CARD', position: 'Cardiologue', isAdmin: false }
    ]
  },
  'dr.mezui.sogara@sante.ga': {
    name: 'Dr. Thomas Mezui',
    roles: [
      { role: 'doctor', department: 'PED', position: 'P√©diatre', isAdmin: false }
    ]
  },
  
  // Infirmiers
  'nurse.mba.sogara@sante.ga': {
    name: 'Sylvie Mba',
    roles: [
      { role: 'nurse', department: 'SI', position: 'Infirmier(e) Chef', isAdmin: false }
    ]
  },
  'nurse.nze.sogara@sante.ga': {
    name: 'Patricia Nze',
    roles: [
      { role: 'nurse', department: 'URG', position: 'Infirmier(e)', isAdmin: false }
    ]
  },
  'nurse.andeme.sogara@sante.ga': {
    name: 'Claire Andeme',
    roles: [
      { role: 'nurse', department: 'MAT', position: 'Infirmier(e) Maternit√©', isAdmin: false }
    ]
  },
  
  // Personnel Support
  'lab.tech.sogara@sante.ga': {
    name: 'Andr√© Moussavou',
    roles: [
      { role: 'laborantin', department: 'LAB', position: 'Technicien Laboratoire', isAdmin: false }
    ]
  },
  'pharma.sogara@sante.ga': {
    name: 'Dr. Lydie Kombila',
    roles: [
      { role: 'pharmacist', department: 'PHAR', position: 'Pharmacien(ne) Chef', isAdmin: false, isDeptHead: true }
    ]
  },
  'accueil.sogara@sante.ga': {
    name: 'Nad√®ge Oyono',
    roles: [
      { role: 'receptionist', department: 'ACC', position: 'R√©ceptionniste', isAdmin: false }
    ]
  }
};

async function setupAllSogaraProfessionals() {
  console.log('üöÄ Configuration de TOUS les professionnels SOGARA\n');
  console.log('================================================\n');

  try {
    // 1. S'assurer que l'√©tablissement SOGARA existe
    console.log('1Ô∏è‚É£ V√©rification de l\'√©tablissement CMST SOGARA...');
    
    const { data: establishment, error: estError } = await supabase
      .from('establishments')
      .select('id, name')
      .eq('id', CMST_SOGARA_ID)
      .single();

    if (estError || !establishment) {
      // Cr√©er l'√©tablissement s'il n'existe pas
      const { error: createError } = await supabase
        .from('establishments')
        .insert({
          id: CMST_SOGARA_ID,
          name: 'CMST SOGARA',
          type: 'cmst',
          sub_type: 'corporate',
          address: 'Zone Industrielle, Port-Gentil',
          city: 'Port-Gentil',
          phone: '+241 01 55 66 77',
          email: 'cmst@sogara.ga',
          website: 'https://sogara.ga/cmst'
        });

      if (createError) {
        console.error('‚ùå Erreur cr√©ation √©tablissement:', createError.message);
        return;
      }
      console.log('   ‚úÖ √âtablissement CMST SOGARA cr√©√©');
    } else {
      console.log('   ‚úÖ √âtablissement CMST SOGARA trouv√©');
    }

    // 2. R√©cup√©rer tous les d√©partements
    console.log('\n2Ô∏è‚É£ R√©cup√©ration des d√©partements...');
    
    const { data: departments } = await supabase
      .from('establishment_departments')
      .select('id, code')
      .eq('establishment_id', CMST_SOGARA_ID);

    const deptMap = {};
    if (departments) {
      departments.forEach(dept => {
        deptMap[dept.code] = dept.id;
      });
    }
    console.log(`   ‚úÖ ${Object.keys(deptMap).length} d√©partements trouv√©s\n`);

    // 3. Traiter chaque professionnel
    console.log('3Ô∏è‚É£ Configuration des professionnels...\n');
    
    let successCount = 0;
    let errorCount = 0;

    for (const [email, config] of Object.entries(SOGARA_PROFESSIONALS)) {
      console.log(`üìå ${config.name} (${email})`);

      try {
        // R√©cup√©rer l'utilisateur
        const { data: userData } = await supabase
          .from('profiles')
          .select('id')
          .eq('email', email)
          .single();

        if (!userData) {
          console.log(`   ‚ö†Ô∏è Utilisateur non trouv√©`);
          errorCount++;
          continue;
        }

        // Cr√©er ou r√©cup√©rer le profil professionnel
        let professionalId;
        const { data: existingPro } = await supabase
          .from('professionals')
          .select('id')
          .eq('user_id', userData.id)
          .single();

        if (existingPro) {
          professionalId = existingPro.id;
        } else {
          const { data: newPro, error: proError } = await supabase
            .from('professionals')
            .insert({
              user_id: userData.id,
              email: email,
              full_name: config.name,
              professional_type: config.roles[0].role === 'doctor' ? 'M√©decin' :
                               config.roles[0].role === 'nurse' ? 'Infirmier(e)' :
                               config.roles[0].role === 'pharmacist' ? 'Pharmacien(ne)' :
                               config.roles[0].role === 'laborantin' ? 'Laborantin(e)' :
                               config.roles[0].role === 'admin' ? 'Administrateur' :
                               config.roles[0].role === 'director' ? 'Directeur' :
                               'Autre'
            })
            .select()
            .single();

          if (proError) {
            console.log(`   ‚ùå Erreur cr√©ation profil: ${proError.message}`);
            errorCount++;
            continue;
          }
          professionalId = newPro.id;
        }

        // Supprimer les anciennes affiliations
        await supabase
          .from('establishment_staff')
          .delete()
          .eq('professional_id', professionalId)
          .eq('establishment_id', CMST_SOGARA_ID);

        // Cr√©er les nouvelles affiliations (multi-r√¥les)
        for (const roleConfig of config.roles) {
          const departmentId = deptMap[roleConfig.department];
          
          const { error: staffError } = await supabase
            .from('establishment_staff')
            .insert({
              professional_id: professionalId,
              establishment_id: CMST_SOGARA_ID,
              department_id: departmentId,
              role: roleConfig.role,
              position: roleConfig.position,
              is_department_head: roleConfig.isDeptHead || false,
              is_establishment_admin: roleConfig.isAdmin || false,
              status: 'active',
              matricule: `${roleConfig.department}-${Date.now().toString().slice(-4)}`
            });

          if (staffError) {
            console.log(`   ‚ùå Erreur affiliation ${roleConfig.role}: ${staffError.message}`);
          } else {
            console.log(`   ‚úÖ R√¥le ${roleConfig.role} - ${roleConfig.position}`);
          }
        }

        successCount++;
        console.log('');

      } catch (error) {
        console.error(`   ‚ùå Erreur: ${error.message}`);
        errorCount++;
      }
    }

    // 4. Cr√©er quelques invitations de test
    console.log('4Ô∏è‚É£ Cr√©ation d\'invitations de test...\n');
    
    // Invitation pour Dr. DJEKI au CHU Libreville
    const { error: invError1 } = await supabase
      .from('establishment_invitations')
      .insert({
        establishment_id: 'b2c3d4e5-f6a7-8901-bcde-f23456789012',
        invited_email: 'directeur.sogara@sante.ga',
        role: 'doctor',
        position: 'M√©decin Consultant Cardiologie',
        message: 'Le CHU Libreville serait honor√© de vous compter parmi son √©quipe de cardiologie.',
        status: 'pending'
      });

    if (!invError1) {
      console.log('   ‚úÖ Invitation CHU Libreville pour Dr. DJEKI cr√©√©e');
    }

    // Invitation pour Dr. Okemba √† la Clinique St-Michel
    const { error: invError2 } = await supabase
      .from('establishment_invitations')
      .insert({
        establishment_id: 'c3d4e5f6-a7b8-9012-cdef-345678901234',
        invited_email: 'dr.okemba.sogara@sante.ga',
        role: 'doctor',
        position: 'M√©decin G√©n√©raliste',
        message: 'La Clinique St-Michel recherche un m√©decin g√©n√©raliste exp√©riment√©.',
        status: 'pending'
      });

    if (!invError2) {
      console.log('   ‚úÖ Invitation Clinique St-Michel pour Dr. Okemba cr√©√©e');
    }

    // 5. R√©sum√©
    console.log('\n================================================');
    console.log('‚ú® Configuration termin√©e!\n');
    
    console.log('üìä R√âSUM√â :');
    console.log(`   ‚úÖ ${successCount} professionnels configur√©s avec succ√®s`);
    if (errorCount > 0) {
      console.log(`   ‚ö†Ô∏è ${errorCount} erreurs rencontr√©es`);
    }
    
    console.log('\nüéØ FONCTIONNALIT√âS ACTIV√âES :');
    console.log('   ‚úÖ Multi-r√¥les (Dr. DJEKI a 2 r√¥les)');
    console.log('   ‚úÖ Multi-√©tablissements pr√™t');
    console.log('   ‚úÖ Syst√®me d\'invitations actif');
    console.log('   ‚úÖ Dashboard adaptatif par r√¥le');
    console.log('   ‚úÖ Menu contextuel dynamique');
    
    console.log('\nüí° POUR TESTER :');
    console.log('   1. Connexion : directeur.sogara@sante.ga / DirecteurSOGARA2024!');
    console.log('   2. V√©rifier le double badge (Directeur + M√©decin)');
    console.log('   3. Tester le menu contextuel');
    console.log('   4. Voir les invitations dans "√âtablissements"');
    
    console.log('\nüîó URLs :');
    console.log('   Dashboard Pro : http://localhost:8080/professional/dashboard');
    console.log('   Dashboard SOGARA : http://localhost:8080/establishments/sogara/admin');
    console.log('   √âtablissements : http://localhost:8080/professional/establishments');

  } catch (error) {
    console.error('\n‚ùå Erreur g√©n√©rale:', error.message);
    process.exit(1);
  }
}

// Ex√©cuter le script
setupAllSogaraProfessionals();
